function fn.goto(x,y,z,dir)
 x,y,z=tonumber(x),tonumber(y),tonumber(z)
 print_("goto",x,y,z,dirs[fn.todir(dir)])
 local i,c,tmp=0,0,false
 
 turtle.select(1)
 while pos.x~=x or pos.y~=y or pos.z~=z do
  fn.refuel(fn.distanct(x,y,z))

  conf.moveUpDown = true
  fn.move('', pos.y-y, fn.tryDown)
  conf.moveUpDown = false

  fn.move('N', pos.z-z) 
  fn.move('E', x-pos.x)
  fn.move('S', z-pos.z)
  fn.move('W', pos.x-x)
  conf.moveUpDown = true
  fn.move(pos.dir, y-pos.y, fn.tryUp)
  conf.moveUpDown = false
 end
 fn.turn(dir)
end
 
function fn.distanct(x,y,z)
  return math.abs(pos.x-x)+math.abs(pos.y-y)+math.abs(pos.z-z)
end

function fn.go(x,y,z,dir)
 x=tonumber(x)+pos.x
 y=tonumber(y)+pos.y
 z=tonumber(z)+pos.z
 fn.goto(x,y,z,dir)
end

function fn.setDigWay(dropWay,digCeiling,digButtom)
 conf.dropWay=fn.tobool(dropWay,conf.dropWay)
 conf.digCeiling=fn.tobool(digCeiling,conf.digCeiling)
 conf.digButtom=fn.tobool(digButtom,conf.digButtom)
end

function fn.digWay()
 if conf.digCeiling and turtle.detectUp() then  fn.tryDigUp() end
 if conf.digButtom and turtle.detectDown() then fn.tryDigDown() end
 if conf.dropWay and not conf.moveUpDown and not turtle.detectDown() then 
  fn.selectAdv(conf.placeSlot,1)
  turtle.placeDown()
  turtle.select(1)
 end  
end

function fn.move(dir, count, act)
 local i,c=0,0
 count=fn.tonumber(count,1)
 if act==nil then act=fn.tryForward end
 if count > 0 then fn.turn(dir) end
 while count>0 do
   if act(5) then 
	fn.digWay()
	count=count-1
   else
     break
   end   
 end
end

function fn.gotoHome()
	fn.loadHome()
	print_("goto Home ",home.x,home.y,home.z,home.dir) 
	fn.goto(home.x,home.y,home.z,home.dir) 
end


function fn.gotoBase()
  local save=conf
  conf.dropWay = false
  conf.digCeiling = false
  conf.digButtom=false

  if pos.x~=base.x or pos.z~=base.z then
    
    if pos.z ~= base.z then
      -- to base.Y
      fn.goto(pos.x, base.y, pos.z)
      fn.goto(base.x, base.y, pos.z)
    end
    fn.goto(base.x, base.y-2, pos.z)
    fn.goto(base.x, base.y-2, base.z)
  end
  conf=save
end

function fn.gotoDigHome(x,y,z)
  local gx,gy,gz = fn.tonumber(x,pos.x),fn.tonumber(y,pos.y),fn.tonumber(z,pos.z)

  if pos.z==base.z then
    fn.goto(pos.x,base.y-2,pos.z)
    fn.goto(base.x,base.y-2,base.z)
    fn.goto(base.x,base.y-2,base.z+1)
  end

  if pos.z~=gz then
    fn.goto(pos.x,base.y-2,gz)
  end

  if pos.y~=base.y then
    fn.goto(pos.x,base.y,pos.z)
  end


  local save=fn.clone(conf)
  conf.dropWay = false
  conf.digCeiling = false
  conf.digButtom=false

  fn.goto(gx,base.y,gz)
  fn.goto(gx,gy+1,gz)
 
  conf=fn.clone(save)
end
